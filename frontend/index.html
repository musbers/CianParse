<!DOCTYPE html>
<html lang="ru">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1" />
		<title>Участки — Mega Table</title>

		<!-- Tabulator CSS/JS -->
		<link
			href="https://unpkg.com/tabulator-tables@5.5.4/dist/css/tabulator.min.css"
			rel="stylesheet"
		/>
		<script src="https://unpkg.com/tabulator-tables@5.5.4/dist/js/tabulator.min.js"></script>

		<!-- PapaParse для CSV -->
		<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

		<!-- SheetJS для экспорта в XLSX (опционально, Tabulator использует глобальный XLSX) -->
		<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

		<style>
			:root {
				--bg: #fbfbfb;
				--card: #ffffff;
				--muted: #666;
				--accent: #2563eb;
			}
			html,
			body {
				height: 100%;
				margin: 0;
				background: var(--bg);
				font-family: Inter, system-ui, Arial, sans-serif;
				color: #111;
			}
			.container {
				max-width: 1200px;
				margin: 20px auto;
				padding: 16px;
			}
			header {
				display: flex;
				align-items: center;
				justify-content: space-between;
				gap: 16px;
				margin-bottom: 12px;
			}
			h1 {
				margin: 0;
				font-size: 20px;
			}
			.controls {
				display: flex;
				gap: 8px;
				align-items: center;
				flex-wrap: wrap;
			}
			.btn {
				padding: 8px 12px;
				border-radius: 8px;
				border: 1px solid #e2e8f0;
				background: var(--card);
				cursor: pointer;
				box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
			}
			.btn:active {
				transform: translateY(1px);
			}
			.search {
				padding: 8px 10px;
				border-radius: 8px;
				border: 1px solid #e2e8f0;
				min-width: 220px;
			}
			.meta {
				color: var(--muted);
				font-size: 13px;
			}
			#land-table {
				height: 70vh;
				border-radius: 8px;
				overflow: hidden;
				background: var(--card);
				padding: 8px;
				box-shadow: 0 6px 18px rgba(15, 23, 42, 0.06);
			}
			.loading {
				display: flex;
				gap: 12px;
				align-items: center;
				color: var(--muted);
				padding: 12px 0;
			}
			.spinner {
				width: 18px;
				height: 18px;
				border-radius: 50%;
				border: 3px solid #eee;
				border-top-color: var(--accent);
				animation: spin 0.9s linear infinite;
			}
			@keyframes spin {
				to {
					transform: rotate(360deg);
				}
			}
			.note {
				margin-top: 8px;
				color: var(--muted);
				font-size: 13px;
			}
			a.small {
				font-size: 13px;
				color: var(--accent);
				text-decoration: none;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<header>
				<div>
					<h1>Таблица земельных участков</h1>
					<div class="meta">
						Данные загружаются с сервера (обновляются сервером в 00:00)
					</div>
				</div>

				<div class="controls" aria-hidden="false">
					<input
						id="global-search"
						class="search"
						placeholder="Поиск по всем колонкам..."
					/>
					<button id="download-csv" class="btn">Экспорт CSV</button>
					<button id="download-xlsx" class="btn">Экспорт XLSX</button>
					<button id="download-json" class="btn">Экспорт JSON</button>
				</div>
			</header>

			<div class="loading" id="loadingRow">
				<div class="spinner" aria-hidden="true"></div>
				<div>Загрузка данных...</div>
			</div>

			<div id="land-table"></div>

			<div class="note">
				Если браузер перенаправил на страницу входа — сначала авторизуйся (POST
				/login) и затем вернись сюда.
				<span style="margin-left: 8px"
					><a href="/login" class="small">Войти</a></span
				>
			</div>
		</div>

		<script>
			// ----- mapping / columns -----
			const columnsDef = [
				{
					field: 'id',
					title: 'ID объявления',
					sorter: 'string',
					headerFilter: 'input',
					width: 100,
				},
				{
					field: 'type',
					title: 'Тип',
					sorter: 'string',
					headerFilter: 'input',
				},
				{
					field: 'area',
					title: 'Площадь',
					sorter: 'number',
					headerFilter: 'input',
				},
				{
					field: 'address',
					title: 'Адрес',
					sorter: 'string',
					headerFilter: 'input',
				},
				{
					field: 'price',
					title: 'Цена',
					sorter: 'number',
					headerFilter: 'input',
					formatter: 'plaintext',
				},
				{
					field: 'phones',
					title: 'Телефоны',
					sorter: 'string',
					headerFilter: 'input',
				},
				{
					field: 'description',
					title: 'Описание',
					sorter: 'string',
					headerFilter: 'input',
				},
				{
					field: 'link',
					title: 'Ссылка на объявление',
					sorter: 'string',
					formatter: 'link',
					formatterParams: {
						labelField: 'link',
						urlField: 'link',
						target: '_blank',
					},
				},
				{
					field: 'metro',
					title: 'Метро',
					sorter: 'string',
					headerFilter: 'input',
				},
			]

			const headerMap = {
				'id объявления': 'id',
				id: 'id',
				id_объявления: 'id',
				тип: 'type',
				type: 'type',
				площадь: 'area',
				пл: 'area',
				'площадь (м2)': 'area',
				адрес: 'address',
				местоположение: 'address',
				цена: 'price',
				стоимость: 'price',
				телефоны: 'phones',
				телефон: 'phones',
				контакты: 'phones',
				описание: 'description',
				комментарий: 'description',
				ссылка: 'link',
				'ссылка на объявление': 'link',
				url: 'link',
				метро: 'metro',
			}

			function normalizeHeader(h) {
				return (h || '').toString().trim().replace(/\s+/g, ' ').toLowerCase()
			}

			function mapRowKeys(row) {
				const mapped = {}
				for (const rawKey in row) {
					const norm = normalizeHeader(rawKey)
					const target = headerMap[norm]
					if (target) {
						// если уже есть значение — конкатенируем через ; чтобы не терять данные
						if (
							mapped[target] !== undefined &&
							row[rawKey] !== undefined &&
							String(row[rawKey]).trim() !== ''
						) {
							// если массив или уже строка — делаем объединение
							if (String(mapped[target]).trim() === '')
								mapped[target] = row[rawKey]
							else if (String(row[rawKey]).trim() !== '')
								mapped[target] =
									String(mapped[target]) + '; ' + String(row[rawKey])
						} else {
							mapped[target] = row[rawKey]
						}
					} else {
						const safe = 'raw_' + norm.replace(/[^a-z0-9_]/g, '_')
						mapped[safe] = row[rawKey]
					}
				}
				return mapped
			}

			// ----- init Tabulator -----
			const table = new Tabulator('#land-table', {
				height: '70vh',
				layout: 'fitDataStretch',
				placeholder: 'Данных пока нет — ожидаем загрузки...',
				columns: columnsDef,
				pagination: 'local',
				paginationSize: 25,
				movableColumns: true,
				resizableRows: true,
				index: 'id',
				tooltips: true,
			})

			// ----- global search -----
			const searchInput = document.getElementById('global-search')
			searchInput.addEventListener('input', e => {
				const v = e.target.value.trim()
				if (!v) {
					table.clearFilter(true)
					return
				}
				table.setFilter(
					[
						{ field: 'id', type: 'like', value: v },
						{ field: 'type', type: 'like', value: v },
						{ field: 'address', type: 'like', value: v },
						{ field: 'description', type: 'like', value: v },
						{ field: 'metro', type: 'like', value: v },
						{ field: 'phones', type: 'like', value: v },
					],
					'or'
				)
			})

			// ----- exports -----
			document
				.getElementById('download-csv')
				.addEventListener('click', () =>
					table.download('csv', 'mega_table_export.csv')
				)
			document
				.getElementById('download-json')
				.addEventListener('click', () =>
					table.download('json', 'mega_table_export.json')
				)
			document.getElementById('download-xlsx').addEventListener('click', () => {
				table.download('xlsx', 'mega_table_export.xlsx', {
					sheetName: 'Участки',
				})
			})

			// ----- add unknown columns dynamically -----
			function addUnknownColumns(rows) {
				if (!rows || !rows.length) return
				const knownFields = columnsDef.map(c => c.field)
				const first = rows[0]
				const extras = Object.keys(first).filter(k => !knownFields.includes(k))
				if (!extras.length) return
				const newCols = extras.map(k => ({
					field: k,
					title: k,
					headerFilter: 'input',
				}))
				try {
					table.addColumn(newCols)
				} catch (e) {
					// если колонка уже добавлена — игнорируем
				}
			}

			// ----- parse and load -----
			function parseAndLoadCSV(csvText) {
				const parsed = Papa.parse(csvText, {
					header: true,
					skipEmptyLines: true,
					dynamicTyping: false,
				})

				if (parsed.errors && parsed.errors.length) {
					console.warn('Ошибка парсинга (первые 5):', parsed.errors.slice(0, 5))
				}

				const rows = parsed.data.map(mapRowKeys)

				// очистка числовых полей
				rows.forEach(r => {
					if (r.area != null && r.area !== '') {
						const n = Number(
							String(r.area)
								.replace(/[^\d.,-]/g, '')
								.replace(',', '.')
						)
						if (!Number.isNaN(n)) r.area = n
					}
					if (r.price != null && r.price !== '') {
						const n = Number(
							String(r.price)
								.replace(/[^\d.,-]/g, '')
								.replace(',', '.')
						)
						if (!Number.isNaN(n)) r.price = n
					}
				})

				// подставим пустые значения для id если нужно (Tabulator удобнее с уникальными id)
				rows.forEach((r, i) => {
					if (!r.id) r.id = 'r_' + i
				})

				table
					.setData(rows)
					.then(() => {
						// добавим динамические колонки в конец
						addUnknownColumns(rows)
						document.getElementById('loadingRow').style.display = 'none'
					})
					.catch(err => {
						console.error('Ошибка установки данных в таблицу:', err)
						document.getElementById('loadingRow').style.display = 'none'
					})
			}

			// ----- auto-load from server -----
			;(function autoLoad() {
				const url = '/mega_table.csv'
				fetch(url, { cache: 'no-store' })
					.then(r => {
						if (r.status === 403 || r.status === 401) {
							// если нет авторизации — перенаправим на страницу логина
							window.location.href = '/login'
							throw new Error('Unauthorized — redirecting to /login')
						}
						if (!r.ok) throw new Error('Ошибка загрузки: ' + r.status)
						return r.text()
					})
					.then(text => parseAndLoadCSV(text))
					.catch(err => {
						console.error(err)
						// если не было редиректа, покажем сообщение пользователю
						const loader = document.getElementById('loadingRow')
						if (loader) {
							loader.innerHTML =
								'<div style="color:#b00020">Не удалось загрузить данные: ' +
								(err.message || err) +
								'</div>'
						}
					})
			})()
		</script>
	</body>
</html>
